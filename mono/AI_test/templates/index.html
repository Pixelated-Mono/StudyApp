<!DOCTYPE html>
<html>
<head>
    <title>AI Chat with Summary</title>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

    <div id="summary-container">
        <h1>AI Generated Summary</h1>
        <div id="summary-content"></div>
    </div>

    <div id="chatbot-wrapper">
        <div class="chat-header">
            <h2>Haalperrr!!!!</h2>
            <button id="clear-chat-btn" class="tooltip" data-tooltip="Clear Chat" onclick="clearChat()">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path><line x1="10" y1="11" x2="10" y2="17"></line><line x1="14" y1="11" x2="14" y2="17"></line></svg>
            </button>
        </div>

        <div id="chat-container">
            {% for message in chat_history %}
                {% if message.startswith("User:") %}
                    <div class="user-message">{{ message.split("User:", 1)[1] }}</div>
                {% else %}
                    <div class="bot-message">{{ message.split("Bot:", 1)[1] }}</div>
                {% endif %}
            {% endfor %}
        </div>

        <div id="input-area">
             <div id="input-form">
                <button id="attachment-btn" class="tooltip" data-tooltip="Add Content" onclick="openModal()">ðŸ“„</button>
                <textarea id="userInput" placeholder="Type your message..." onkeydown="handleKey(event)"></textarea>
            </div>
            <div id="attachment-info"></div>
        </div>
    </div>

    <div id="modal-backdrop" onclick="closeModal()"></div>
    <div id="attachment-modal">
        <h3>Add Content</h3>
        <div class="input-group">
            <div>
                 <label for="fileInput">ðŸ“„ Upload PDF</label>
                <input type="file" id="fileInput" accept=".pdf" onchange="updateAttachmentInfo()">
            </div>
            <div class="input-container">
                <span>ðŸ”—</span>
                <input type="text" id="youtubeUrlInput" placeholder="Paste YouTube URL here" oninput="updateAttachmentInfo()">
            </div>
        </div>
        <div id="modal-actions">
            <button onclick="clearAttachments(true)">Clear</button>
            <button class="primary" onclick="closeModal()">Confirm</button>
        </div>
    </div>

    <div id="selection-popup" class="tooltip" data-tooltip="Explain Selection">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
    </div>

    <div id="chat-orb" class="tooltip" data-tooltip="Open Chat" onclick="toggleChat()">
        <svg id="orb-icon-open" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>
        <svg id="orb-icon-close" style="display: none;" xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
    </div>
    
    <script>
    // --- FINAL, ROBUST LOGIC FOR SELECTION POP-UP ---
    const summaryContent = document.getElementById('summary-content');
    const selectionPopup = document.getElementById('selection-popup');
    let selectedText = '';

    // NEW: Use mousedown to reliably hide the pop-up.
    // This event fires the moment you click anywhere.
    document.addEventListener('mousedown', (event) => {
        // If the click is on the pop-up itself, do nothing.
        if (selectionPopup.contains(event.target)) {
            return;
        }
        // For any other click, immediately hide the pop-up.
        selectionPopup.classList.remove('visible');
    });

    // REFINED: The mouseup event is now ONLY responsible for SHOWING the pop-up.
    summaryContent.addEventListener('mouseup', () => {
        // Use a short timeout to make sure the browser has registered the selection.
        setTimeout(() => {
            const selection = window.getSelection();
            if (selection && selection.rangeCount > 0) {
                selectedText = selection.toString().trim();

                if (selectedText.length > 0) {
                    const range = selection.getRangeAt(0);
                    const rect = range.getBoundingClientRect();

                    selectionPopup.style.left = `${rect.left - (selectionPopup.offsetWidth / 2)}px`;
                    selectionPopup.style.top = `${rect.top - selectionPopup.offsetHeight - 5 + window.scrollY}px`;
                    selectionPopup.classList.add('visible');
                }
            }
        }, 10);
    });

    // The click handler for the pop-up remains the same.
    selectionPopup.addEventListener('click', () => {
        if (selectedText) {
            sendSelectedTextToAI(selectedText);
            selectionPopup.classList.remove('visible');
            window.getSelection().removeAllRanges();
        }
    });

    async function sendSelectedTextToAI(text) {
        const chatbotWrapper = document.getElementById('chatbot-wrapper');
        if (!chatbotWrapper.classList.contains('visible')) {
            toggleChat();
        }
        const chatContainer = document.getElementById("chat-container");
        const userMsgDiv = document.createElement("div");
        userMsgDiv.className = "user-message";
        userMsgDiv.innerText = `Explain: "${text}"`;
        chatContainer.appendChild(userMsgDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        const formData = new FormData();
        formData.append("message", `Please explain the following term or concept in a clear and concise way: "${text}"`);
        const res = await fetch("/ask", { method: "POST", body: formData });
        const data = await res.json();
        const botMsgDiv = document.createElement("div");
        botMsgDiv.className = "bot-message";
        botMsgDiv.innerText = data.chat_reply;
        chatContainer.appendChild(botMsgDiv);
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    // --- ALL PREVIOUS JAVASCRIPT REMAINS BELOW ---
    function toggleChat() {
        const chatbotWrapper = document.getElementById('chatbot-wrapper');
        const orb = document.getElementById('chat-orb');
        const openIcon = document.getElementById('orb-icon-open');
        const closeIcon = document.getElementById('orb-icon-close');
        
        chatbotWrapper.classList.toggle('visible');
        orb.classList.toggle('orb-integrated');

        const isVisible = chatbotWrapper.classList.contains('visible');
        if (isVisible) {
            openIcon.style.display = 'none';
            closeIcon.style.display = 'block';
            orb.setAttribute('data-tooltip', 'Close Chat');
        } else {
            openIcon.style.display = 'block';
            closeIcon.style.display = 'none';
            orb.setAttribute('data-tooltip', 'Open Chat');
        }
    }

    const modal = document.getElementById('attachment-modal');
    const backdrop = document.getElementById('modal-backdrop');
    const fileInput = document.getElementById('fileInput');
    const youtubeUrlInput = document.getElementById('youtubeUrlInput');
    const attachmentInfoDiv = document.getElementById('attachment-info');

    function openModal() {
        backdrop.style.display = 'block';
        modal.classList.add('visible');
    }

    function closeModal() {
        modal.classList.remove('visible');
        backdrop.style.display = 'none';
    }

    function updateAttachmentInfo() {
        const attachments = [];
        const file = fileInput.files[0];
        const youtubeUrl = youtubeUrlInput.value;
        if (file) {
            attachments.push(`ðŸ“„ ${file.name}`);
        }
        if (youtubeUrl) {
            attachments.push(`ðŸ”— YouTube Link`);
        }
        attachmentInfoDiv.textContent = attachments.join(' & ');
    }
    
    function clearAttachments(isFromModal = false) {
        fileInput.value = "";
        youtubeUrlInput.value = "";
        updateAttachmentInfo();
        if (isFromModal) closeModal();
    }

    async function sendToAI() {
        const userInput = document.getElementById("userInput").value;
        const file = fileInput.files[0];
        const youtubeUrl = youtubeUrlInput.value;
        if (!userInput && !file && !youtubeUrl) {
            alert("Please enter a message or add content to summarize.");
            return;
        }
        const chatContainer = document.getElementById("chat-container");
        const userMsgDiv = document.createElement("div");
        userMsgDiv.className = "user-message";
        userMsgDiv.innerText = userInput || "Sent content for processing...";
        chatContainer.appendChild(userMsgDiv);
        document.getElementById("userInput").value = "";
        const formData = new FormData();
        formData.append("message", userInput);
        if (file) {
            formData.append("file", file);
        }
        if (youtubeUrl) {
            formData.append("youtube_url", youtubeUrl);
        }
        clearAttachments();
        const res = await fetch("/ask", {
            method: "POST",
            body: formData
        });
        const data = await res.json();
        const botMsgDiv = document.createElement("div");
        botMsgDiv.className = "bot-message";
        botMsgDiv.innerText = data.chat_reply;
        chatContainer.appendChild(botMsgDiv);
        const summaryContainer = document.getElementById("summary-container");
        if (data.summary_content) {
            summaryContent.innerHTML = marked.parse(data.summary_content);
            summaryContainer.style.display = 'block';
        }
        chatContainer.scrollTop = chatContainer.scrollHeight;
    }
    
    async function clearChat() {
        await fetch("/clear", { method: "POST" });
        document.getElementById("chat-container").innerHTML = "";
        summaryContent.innerHTML = "";
        document.getElementById("summary-container").style.display = "none";
        clearAttachments();
        alert("Chat history and summary cleared!");
    }

    function handleKey(event) {
        if (event.key === "Enter" && !event.shiftKey) {
            event.preventDefault(); 
            sendToAI();
        }
    }
</script>
</body>
</html>